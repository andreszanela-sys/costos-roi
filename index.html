<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Costos ocultos + ROI</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<style>
  :root { color-scheme: light; }
  html, body { height: 100%; margin: 0; }
  body{ background:#fff; font-family:Inter,system-ui,Arial; }
  .wrap{
    box-sizing:border-box;
    padding:10px 12px;
    height:100%;                 /* ocupa todo el alto del iframe */
    display:grid;
    grid-template-rows:auto auto minmax(420px,1fr);
    gap:8px;
  }

  h3{margin:0;font-size:16px;font-weight:600;color:#111}
  .meta{font-size:12px;color:#444}
  /* El canvas llena la fila 3 */
  #chart{
    width:100% !important;
    height:100% !important;       /* que use todo el espacio disponible */
    display:block;
    background:#fff; 
  }
</style>

</head><body>
<div class="wrap">
  <h3>Costos Ocultos & ROI recuperable</h3>
  <div class="meta" id="chartMeta"></div>

  <canvas id="chart" style="width:100%;height:100%;display:block;"></canvas>

</div>


<script>
// ===== helper: ¬øel origin entra en la lista?
function originPermitido(origin){
  try {
    const h = new URL(origin).hostname;
    return (
      origin === 'https://innovacionregenerativa.com' ||
      origin === 'https://www.innovacionregenerativa.com' ||
      h.endsWith('.wixsite.com') ||
      h.endsWith('.wix.com') ||
      h === 'editor.wixapps.net'
    );
  } catch(_) { return false; }
}

/* ====== Paleta y labels por omisi√≥n ====== */
const PALETTE = { green:"#00A676", bar:"#F6DFA7", grid:"#EEF2F7", text:"#111" };
const DEFAULT_LABELS_ES = [
  ['Prop√≥sito', 'y estrategia'],
  ['Liderazgo', 'y gobernanza'],
  ['Cultura', 'y bienestar'],
  ['Aprendizaje', 'e innovaci√≥n'],
  ['Procesos', 'y tecnolog√≠a'],
  ['Sostenibilidad', 'e impacto']
];


let chart = null;
let lastPayload = null;

// DPI estable en HiDPI
Chart.defaults.devicePixelRatio = () => window.devicePixelRatio || 1;

// ResizeObserver para que el canvas crezca con el iframe
let ro, rafId = 0, resizeTimer = 0;
function mountResizeObserver() {
  try {
    const el = document.querySelector('.wrap');
    if (!el) return;
    ro?.disconnect?.();
    ro = new ResizeObserver(() => {
      cancelAnimationFrame(rafId);
      clearTimeout(resizeTimer);
      rafId = requestAnimationFrame(()=>{
        resizeTimer = setTimeout(()=>{
          if (chart) chart.resize();
          else if (lastPayload) buildWhenReady(lastPayload);
        }, 120);
      });
    });
    ro.observe(el);
  } catch(_) {}
}
document.addEventListener('DOMContentLoaded', mountResizeObserver);
window.addEventListener('load', mountResizeObserver);

/* ====== Helpers ====== */
function fmtMoney(n, lang='es'){
  try { return (n??0).toLocaleString(lang==='en'?'en-US':'es-MX',{maximumFractionDigits:0}); }
  catch { return Math.round(n||0).toString(); }
}

function ensureArraysFromPayload(payload){
  let labels = (payload.labels && payload.labels.length)
    ? payload.labels
    : DEFAULT_LABELS_ES;
  labels = labels.map(l => Array.isArray(l) ? l : (l != null ? String(l) : ''));
  // costos: aceptar array o objeto {proposito, liderazgo, ...}
  let costosArr = [];
  if (Array.isArray(payload.costos)) costosArr = payload.costos.map(n => Number(n||0));
  else if (payload.costos && typeof payload.costos === 'object'){
    const order = ['proposito','liderazgo','cultura','aprendizaje','procesos','sostenibilidad'];
    costosArr = order.map(k => Number(payload.costos[k]||0));
  } else costosArr = new Array(6).fill(0);

  // promedios: array [1..5]
  const promedios = Array.isArray(payload.promedios) ? payload.promedios.map(Number) : new Array(6).fill(3);
  return {labels, costosArr, promedios};
}

// tasa recuperable seg√∫n nivel (para la l√≠nea)
function urgFromAvg(avg, cfg){
  const r = (cfg?.recRates) || {};
  if (avg<=2.3) return {tag:'En crisis',      recRate:r.crisis       ?? 0.70};
  if (avg<=3.2) return {tag:'Desconectado',   recRate:r.desconectado ?? 0.60};
  if (avg<=4.1) return {tag:'En transici√≥n',  recRate:r.transicion   ?? 0.45};
  return            {tag:'Regenerativa',      recRate:r.regenerativa ?? 0.30};
}

function buildWhenReady(payload){
  lastPayload = payload;
  const canvas = document.getElementById('chart');

  function tick(){
    const w = canvas.offsetWidth || canvas.clientWidth || 0;
    const h = canvas.offsetHeight || canvas.clientHeight || 0;

    // solo construimos cuando el iframe ya est√° expandido en Wix
    if (w > 40 && h > 40) {
      build(payload);
    } else {
      requestAnimationFrame(tick); // vuelve a intentar en el pr√≥ximo frame
    }
  }

  tick();
}


function notifyCostosReady() {
  const snap = getChartPNG();
  if (snap && snap.dataURL) {
    window.parent?.postMessage({
      type: 'costos-ready',
      imagenes: {
        costos:    snap.dataURL,   // data:image/jpeg;base64,...
        costosW:   snap.w,
        costosH:   snap.h,
        costosFmt: snap.fmt        // 'JPEG'
      }
    }, '*');
  } else {
    // reintento breve por si a√∫n no termin√≥ de pintar
    setTimeout(() => {
      const again = getChartPNG();
      if (again && again.dataURL) {
        window.parent?.postMessage({
          type: 'costos-ready',
          imagenes: {
            costos:    again.dataURL,
            costosW:   again.w,
            costosH:   again.h,
            costosFmt: again.fmt
          }
        }, '*');
      }
    }, 120);
  }
}



/*function notifyCostosReady() {
  const snap = getChartPNG();                 // usa tu funci√≥n existente
  if (snap && snap.dataURL) {
    window.parent?.postMessage({
      type: 'costos-ready',                   // üîë lo que espera tu padre
      png:  snap.dataURL,                     // data:image/jpeg;base64,...
      w:    snap.w,
      h:    snap.h,
      fmt:  snap.fmt || 'JPEG'
    }, '*');
  } else {
    // opcional: reintenta una vez si sali√≥ ‚ÄúPENDING‚Äù (todo blanco)
    setTimeout(() => {
      const again = getChartPNG();
      if (again && again.dataURL) {
        window.parent?.postMessage({
          type: 'costos-ready',
          png:  again.dataURL,
          w:    again.w,
          h:    again.h,
          fmt:  again.fmt || 'JPEG'
        }, '*');
      }
    }, 120);
  }
}*/



/* ====== Construcci√≥n del gr√°fico ====== */
function build(payload){
  const cfg = payload.config || {};
  const {labels, costosArr, promedios} = ensureArraysFromPayload(payload);

  console.debug('[COSTOS] payload recibido:', payload);
  console.debug('[COSTOS] costosArr:', costosArr, 'promedios:', promedios);

  const canvas = document.getElementById('chart');
  if (!canvas) { console.error('[COSTOS] No se encontr√≥ #chart'); return; }

  const costoTotal = Math.round(costosArr.reduce((a,b)=>a+(+b||0),0));
  const rec = costosArr.map((c,i)=> Math.round((+c||0) * urgFromAvg(promedios[i], cfg).recRate));
  const recTotal = Math.round(rec.reduce((a,b)=>a+b,0));

  const curr = cfg.currency || 'USD';
  const hz   = cfg.horizonte || '12‚Äì18 meses';
  const roiMin = Number(cfg.roiMultipleMin ?? 5);

  // texto superior
  const metaEl = document.getElementById('chartMeta');
  if (metaEl) {
    metaEl.textContent =
      `Costo oculto total ‚âà $${fmtMoney(costoTotal, payload.lang)} ${curr} ¬∑ ` +
      `Recuperable (${hz}): $${fmtMoney(recTotal, payload.lang)} ${curr}`;
  }
  // l√≠mites sugeridos para que no quede en 0‚Äì1
  const maxBar  = Math.max(...costosArr, 0);
  const maxLine = Math.max(...rec, 0);
  const maxY    = Math.max(maxBar, maxLine, 1);

  const backgroundFillPlugin = {
  id: 'backgroundFill',
  beforeDraw(chart) {
    const { ctx, width, height } = chart;
    ctx.save();
    // pinta TODO el canvas de blanco antes de dibujar cualquier cosa
    ctx.globalCompositeOperation = 'destination-over';
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, width, height);
    ctx.restore();
  }
};


  /*const backgroundFillPlugin = {
    id: 'backgroundFill',
    beforeDraw(chart) {
      const { ctx, chartArea } = chart;
      if (!chartArea) return;
      const { left, top, width, height } = chartArea;
      ctx.save();
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(left, top, width, height);
      ctx.restore();
    }
  };*/


 try {
    if (chart) chart.destroy();
    chart = new Chart(canvas, {
    type: 'bar',   // ‚Üê ESTA L√çNEA ES LA DIFERENCIA
    plugins: [backgroundFillPlugin],  // üëà aqu√≠ lo registras
    data:{
      labels,
      datasets:[
        {
          type:'bar',
          label: `Costo oculto (${curr})`,
          data: costosArr,
          backgroundColor: PALETTE.bar,
          borderWidth: 0,
          borderRadius: 8,
          barThickness: 38,
          maxBarThickness: 42
        },
        {
          type:'line',
          label: `Recuperable estimado (${curr})`,
          data: rec,
          borderColor: PALETTE.green,
          pointBackgroundColor: PALETTE.green,
          pointBorderColor: '#fff',
          pointBorderWidth: 1,
          pointRadius: 3,
          pointHoverRadius: 5,
          tension: 0.25,
          fill: false,
          yAxisID: 'y'
        }
      ]
    },

    options:{
      responsive:true,
      maintainAspectRatio:false,
      normalized:true,
      layout:{ padding:{ top: 6, right: 6, bottom: 6, left: 0 } },
      plugins:{

        legend:{ position:'top', labels:{ color: PALETTE.text, usePointStyle:true, boxWidth: 10 } },
        tooltip:{
          callbacks:{
            label: (ctx)=>{
              const val = ctx.raw||0;
              return `${ctx.dataset.label}: $${fmtMoney(val, payload.lang)} ${curr}`;
              //return `${ctx.dataset.label}: $${fmtMoney(val, payload.lang)} USD`;
            },
            afterBody:(items)=>{
              const i = items[0].dataIndex;
              const u = urgFromAvg(promedios[i], cfg);
              const r = rec[i]||0;
              const pot = Math.round(r * roiMin);
              return [
                `Nivel: ${u.tag}`,
                `ROI potencial (‚â•${roiMin}x): $${fmtMoney(pot, payload.lang)} ${curr}`
              ];
            }
          }
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          suggestedMax: Math.round(maxY * 1.15),
          grid:{ color: PALETTE.grid },
          ticks:{ callback:(v)=>'$'+fmtMoney(v, payload.lang)+' '+curr, precision: 0 }
        },
        x:{ grid:{ display:false }, ticks:{ color: PALETTE.text, maxRotation: 0, autoSkip: false } }
      },
      animation:{ duration: 600, easing: 'easeOutQuart' }
    }
  });
  window.chart = chart;


// Si quieres mantener animaci√≥n visual pero avisar justo al final:
if (chart?.options?.animation) {
  const prev = chart.options.animation.onComplete;
  chart.options.animation.onComplete = (ctx) => {
    try { prev?.(ctx); } catch(_) {}
    // ‚úÖ avisa al padre que la gr√°fica ya est√° ‚Äúconstruida‚Äù
    try { window.parent?.postMessage({ type:'built', chart:'costos' }, '*'); } catch(_) {}
    notifyCostosReady();
  };
} else {
  // fallback por si alguien quita la animaci√≥n en el futuro
  try { window.parent?.postMessage({ type:'built', chart:'costos' }, '*'); } catch(_) {}
  requestAnimationFrame(() => notifyCostosReady());
}

  //try { window.parent?.postMessage({ type:'built', chart:'costos' }, '*'); } catch(_) {}

  } catch (e){
    console.error('[COSTOS] Error construyendo Chart:', e);
  }
}


function getChartPNG() {
  try {
    if (window.chart && typeof window.chart.toBase64Image === 'function') {
      const dataURL = window.chart.toBase64Image('image/jpeg', 0.92); // JPEG liviano
      const w = window.chart?.canvas?.width  || 980;
      const h = window.chart?.canvas?.height || 540;
      return { dataURL, w, h, fmt: 'JPEG' };
    }
    const cv = document.getElementById('chart');
    if (cv?.toDataURL) {
      return { dataURL: cv.toDataURL('image/jpeg', 0.92), w: cv.width, h: cv.height, fmt:'JPEG' };
    }
    return { dataURL:null, w:0, h:0, fmt:'ERROR' };
  } catch (e) {
    return { dataURL:null, w:0, h:0, fmt:'ERROR' };
  }
}





/*function getChartPNG() {
  try {
    const src = document.getElementById('chart');

    // 1) raster temporal con fondo blanco (evita ‚Äúcuadro negro‚Äù en PDF)
    const tmp = document.createElement('canvas');
    tmp.width  = src.width  || src.clientWidth  || 980;
    tmp.height = src.height || src.clientHeight || 540;
    const ctx = tmp.getContext('2d', { willReadFrequently: true });
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, tmp.width, tmp.height);
    ctx.drawImage(src, 0, 0);

    // 2) sanity check: ¬øhay algo dibujado adem√°s del blanco?
    const probe = ctx.getImageData(
      Math.max(0, Math.floor(tmp.width*0.5)-2),
      Math.max(0, Math.floor(tmp.height*0.5)-2),
      4, 4
    ).data;
    const allWhite = (() => {
      for (let i = 0; i < probe.length; i += 4) {
        if (!(probe[i]===255 && probe[i+1]===255 && probe[i+2]===255)) return false;
      }
      return true;
    })();
    if (allWhite) {
      // si a√∫n est√° ‚Äúen blanco‚Äù, avisa arriba para reintentar
      return { dataURL: null, w: tmp.width, h: tmp.height, fmt: 'PENDING' };
    }

    // 3) exporta **JPEG** (menor peso; evitas transparencias)
    const dataURL = tmp.toDataURL('image/jpeg', 0.9);
    return { dataURL, w: tmp.width, h: tmp.height, mime: 'image/jpeg', fmt: 'JPEG' };
  } catch (e) {
    return { dataURL: null, w:0, h:0, error: e?.message || String(e), fmt: 'ERROR' };
  }
}*/





/*function getChartPNG() {
  try {
    if (window.chart && typeof window.chart.toBase64Image === 'function') {
      const dataURL = window.chart.toBase64Image('image/png', 1.0);
      const w = window.chart?.canvas?.width  || 980;
      const h = window.chart?.canvas?.height || 540;
      return { dataURL, w, h };
    }
    const canvas = document.getElementById('chart');
    if (canvas && canvas.toDataURL) {
      const dataURL = canvas.toDataURL('image/png', 1.0);
      return { dataURL, w: canvas.width || 980, h: canvas.height || 540 };
    }
    return { dataURL: null, w: 0, h: 0, error: 'No chart/canvas available' };
  } catch(e) {
    return { dataURL: null, w: 0, h: 0, error: e?.message || String(e) };
  }
}*/



/* ====== Handshake con Velo ====== */
window.addEventListener('load', () => {
  window.parent?.postMessage({ type: 'ready', chart: 'costos' }, '*');
});

/* ====== Listener para recibir datos ====== */
window.addEventListener('message', (ev)=>{
  if (!ev || !ev.data) return;
  // Si no viene origin (p.ej. entornos de prueba), no bloquees; o mant√©n tu whitelist:
  if (ev.origin && !originPermitido(ev.origin)) return;
  
  const d = ev?.data ?? {};

    // 1) Cargar/actualizar la gr√°fica
    if (d.type === 'costos' || Array.isArray(d.costos) || (d.costos && typeof d.costos === 'object')) {
      lastPayload = d;
      buildWhenReady(d);

      // auto-snapshot opcional: si Velo manda autosnap:true, devolvemos imagen al terminar
      if (d.autosnap) {
        setTimeout(() => {
          const snap = getChartPNG();
          window.parent?.postMessage({ type:'snapshot-ok', chart: d.chart || 'costos', ...snap }, '*');
        }, 60);
      }
      return;
    }

    // 2) Petici√≥n expl√≠cita de snapshot
    if (d.type === 'snapshot' || d.type === 'get-snapshot') {
    const snap = getChartPNG();
    window.parent?.postMessage({ type:'snapshot-ok', chart: d.chart || 'costos', ...snap }, '*');
    return;
    }



  
  /*const d = ev.data || {};
  if (d.type==='costos' || Array.isArray(d.costos) || (d.costos&& typeof d.costos==='object')) {
    buildWhenReady(d);
  } else if (Array.isArray(d)) {
    buildWhenReady({ costos:d, promedios:new Array(d.length).fill(3), labels:DEFAULT_LABELS_ES, lang:'es' });
  } else if (d.type === 'snapshot') {
    const snap = getChartPNG();
    window.parent?.postMessage({ type:'snapshot-ok', chart:d.chart||'costos', ...snap }, '*');
  }*/
});

/* ====== Render inicial (sin datos) ====== */
buildWhenReady({ costos:[0,0,0,0,0,0], promedios:[3,3,3,3,3,3], labels:DEFAULT_LABELS_ES, lang:'es' });
</script>

</body></html>
